#!/bin/bash
# Create .desktop entry (v2)

# Structure of command:
#
# 	xdesk ACTION [OPTS] --file FILE
# 
# -f --file: target for the .desktop entry
#
# OPTS are:
# 	-n --name: .desktop Name key
# 	-e --exec: .desktop Exec key
# 	-i --icon: [...]
# 	-T --terminal: sets Terminal key to true
# 	-t --type: .desktop Type key
# 	-G --non-default-GPU: sets PrefersNonDefaultGPU key to false
# 	-c --categories: .desktop Categories key
# 	-m --mimetype: .desktop MimeType key
# 	-w --wmclass: .desktop StartupWMClass key
# 	-d --dir: .desktop entry location;
#
# ACTIONS are:
# 	--install: create a new .desktop entry
# 	--modify: modify existing .desktop entry
# 	--remove: remove a .desktop entry
# 	--display: content of entry
# 	--list: entries in dir
#
#
# Defaults:
#
# 	--dir: Defaults to $HOME/.local/share/applications
# 	--type: Defaults to "Application"
# 	--terminal: false
# 	--non-default-gpu: true
# 	--exec: FILE
# 	--name: ${FILE%%.*}



function parse_option(){

	# Parses the opt value so to prevent issues with sed

	value="$1"
	lookup="/"
	new_value=""

	for (( i=0; i<${#value}; i++ )); do

		x="$(echo "$lookup" | grep -F "${value:i:1}")"
		if [[ -n "$x" ]]; then
			new_value+="\\${value:i:1}"
			continue
		fi
		new_value+="${value:i:1}"
	done

	echo "$new_value"
}



declare -A VARS      # utilities like install_dir, file etc
declare -A OPTS      # Stores option values.
declare -A GIVEN     # This tracks whether or not an option was given by the user
		     # in order to avoid changing options that were not given, 
		     # and are different in the file from the default values.

# Variables that will hold default values
VARS["INSTALL_DIR"]="$HOME/.local/share/applications"
OPTS["Type"]="Application"
OPTS["Terminal"]="false"
OPTS["PrefersNonDefaultGPU"]="true"
OPTS["Exec"]=""
OPTS["Name"]=""

# Non-default, optional
OPTS["Categories"]=""
OPTS["MimeType"]=""
OPTS["StartupWMClass"]=""
OPTS["Icon"]=""

# Required
VARS["FILE"]=""

# Action
VARS["ACTION"]="INSTALL"

TEMP=$(getopt \
	-o 'n:e:i:Tt:Gc:m:w:d:f:' \
	-l 'install,modify,remove,display,list,file:,name:,exec:,icon:,terminal,type:, \
	non-default-gpu,categories:,mimetype:,wmclass:,dir:' \
	-n "$0" -- "$@")

if [[ $? -ne 0 ]]; then
	echo "" >&2
	exit 1
fi

eval set -- "$TEMP"
unset TEMP

while true; do
	case "$1" in
		"--install")
			VARS["ACTION"]="INSTALL"
			shift
			continue
			;;
		"--modify")
			VARS["ACTION"]="MODIFY"
			shift
			continue
			;;
		"--remove")
			VARS["ACTION"]="REMOVE"
			shift
			continue
			;;
		"--display")
			VARS["ACTION"]="DISPLAY"
			shift
			continue
			;;
		"--list")
			VARS["ACTION"]="LIST"
			shift
			continue
			;;
		"-f" | "--file")
			FILE="$(basename $2)"
			FILE="${FILE%%.*}"
			FILE="${FILE}.desktop"
			VARS["FILE"]="$FILE"
			unset FILE

			shift 2
			continue
			;;
		"-n" | "--name")
			OPTS["Name"]="$2"

			GIVEN["Name"]="true"

			shift 2
			continue
			;;
		"-e" | "--exec")
			OPTS["Exec"]="$2"

			GIVEN["Exec"]="true"

			shift 2
			continue
			;;
		"-i" | "--icon")
			OPTS["Icon"]="$2"

			GIVEN["Icon"]="true"
			
			shift 2
			continue
			;;
		"-T" | "--terminal")
			OPTS["Terminal"]="true"

			GIVEN["Terminal"]="true"
			
			shift
			continue
			;;
		"-t" | "--type")
			OPTS["Type"]="$2"

			GIVEN["Type"]="true"
			
			shift 2
			continue
			;;
		"-G" | "--non-default-gpu")
			OPTS["PrefersNonDefaultGPU"]="false"

			GIVEN["PrefersNonDefaultGPU"]="true"
			
			shift
			continue
			;;
		"-c" | "--categories")
			OPTS["Categories"]="$2"
			
			GIVEN["Categories"]="true"

			shift 2
			continue
			;;
		"-m" | "--mimetype")
			OPTS["MimeType"]="$2"
			
			GIVEN["MimeType"]="true"

			shift 2
			continue
			;;
		"-w" | "--wmclass")
			OPTS["StartupWMClass"]="$2"
			
			GIVEN["StartupWMClass"]="true"

			shift 2
			continue
			;;
		"-d" | "--dir")
			VARS["INSTALL_DIR"]="$2"
			shift 2
			continue
			;;
		--)
			shift
			break
			;;
		*)
			echo "invalid arg $1"
			exit 1
			;;
	esac
done

VARS["FPATH"]="${VARS["INSTALL_DIR"]}/${VARS["FILE"]}"

if [[ "${VARS["ACTION"]}" = "INSTALL" ]]; then
	echo "install..."

	if [[ -f "${VARS["FPATH"]}" ]]; then
		echo "file exists. try --modify instead"
		exit 4
	fi

	if [[ "${OPTS["Name"]}" = "" ]]; then
		NAME="${FILE%%.*}"
		OPTS["Name"]="${NAME^}"
		unset NAME
	fi

	if [[ "${OPTS["Exec"]}" = "" ]]; then
		OPTS["Exec"]="$HOME/.local/bin/${VARS["FILE"]}"
		if ! [[ -f "${OPTS["Exec"]}" ]]; then
			echo "Executable for ${VARS["FILE"]} not located."
			echo "Please note if --exec is not given, it defaults to ~/.local/bin"
			echo "Cancelled."
			exit -55
		fi
	fi

	touch "${VARS["FPATH"]}"
	echo "[Desktop Entry]" > "${VARS["FPATH"]}"

	for key in "${!OPTS[@]}"; do
		echo "$key=${OPTS["$key"]}" >> "${VARS["FPATH"]}"
	done

elif [[ "${VARS["ACTION"]}" = "MODIFY" ]]; then
	echo "modify..."
	if ! [[ -f "${VARS["FPATH"]}" ]]; then
		echo "file does not exist. Try --install instead"
		exit 4
	fi

	for key in "${!GIVEN[@]}"; do

		if [[ -n "$(cat ${VARS["FPATH"]} | grep "$key")" ]]; then
			opt="$(parse_option "${OPTS["$key"]}")"
			sed -i -r "s/$key.*/$key=$opt/" "${VARS["FPATH"]}"
		else
			opt="${OPTS["$key"]}"
			echo "$key=$opt" >> "${VARS["FPATH"]}"
		fi

	done
	
	cat "${VARS["FPATH"]}"


elif [[ "${VARS["ACTION"]}" = "REMOVE" ]]; then
	
	if [[ "${VARS["FILE"]: -8}" != ".desktop" ]]; then
		echo "Not a desktop entry"
		exit -9
	elif ! [[ -f "${VARS["FPATH"]}" ]]; then
		echo "File does not exist"
		exit 3
	else
		rm "${VARS["FPATH"]}"
		echo "File ${VARS["FILE"]} has been removed"
		exit 0
	fi
elif [[ "${VARS["ACTION"]}" = "DISPLAY" ]]; then
	
	if [[ -f "${VARS["FPATH"]}" ]]; then
		cat "${VARS["FPATH"]}"
	else
		echo "File does not exist"
		exit 3
	fi
elif [[ "${VARS["ACTION"]}" = "LIST" ]]; then

	if [[ -d "${VARS["INSTALL_DIR"]}" ]]; then
		ls -A "${VARS["INSTALL_DIR"]}" | grep -i -n -T --color='never' ".*.desktop"
	else
		echo "Directory does not exist"
		exit 3
	fi
else
	echo "invalid option."
	echo "Valid options are:"
 	echo "--install: create a new .desktop entry"
 	echo "--modify: modify existing .desktop entry"
 	echo "--remove: remove a .desktop entry"
 	echo -e "Note the --remove action can only take the --dir option indicating where the entry is located. If anything else is passed the script will return an error. --dir defaults to INSTALL_DIR"
fi


#echo "INSTALL_DIR = ${VARS["INSTALL_DIR"]}"
#echo "TYPE = ${OPTS["Type"]}"
#echo "TERMINAL = ${OPTS["Terminal"]}"
#echo "PREFERSNDGPU = ${OPTS["PrefersNonDefaultGPU"]}"
#echo "ICON = ${OPTS["Icon"]}"
#echo "EXEC = ${OPTS["Exec"]}"
#echo "NAME = ${OPTS["Name"]}"
#echo "CATEGORIES = ${OPTS["Categories"]}"
#echo "MIMETYPE = ${OPTS["MimeType"]}"
#echo "WMCLASS = ${OPTS["StartupWMClass"]}"
#echo "FILE = ${VARS["FILE"]}"
#echo "ACTION = ${VARS["ACTION"]}"




